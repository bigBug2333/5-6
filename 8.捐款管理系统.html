<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>捐赠管理</title>
  <style type="text/css">
    * {
      font-family: 微软雅黑;
    }

    h1 {
      text-align: center;
    }

    div {
      width: 940px;
      padding: 5px;
      margin: 2px auto;
      border: 1px solid #0094ff;
    }

    #tbData {
      border: 1px solid #0094ff;
      border-collapse: collapse;
      width: 950px;
      margin: 2px auto;
    }

    #tbData th {
      color: #fff;
      background-color: #0094ff;
    }

    #tbData th, td {
      border: 1px solid #000;
      padding: 5px;
      text-align: center;
    }
  </style>
</head>
<body>
<h1>捐赠管理</h1>
<div>
  受捐单位：
  <!--查询用的下拉框-->
  <select id="selSearchOrg">
    <option value="-1">请选择</option>
  </select>
  <!--查询的按钮-->
  <input type="button" id="btnSearch" value="查询"/>
</div>
<div>
  捐赠人：<input type="text" id="txtName"/>

  <!--增加用的select框-->
  受捐单位：<select id="selAddOrg"></select>
  金额：<input type="text" id="txtMoney"/>
  受捐日期：<input type="text" id="txtDate"/>
  <input type="button" id="btnAdd" value="新增"/>
</div>
<table id="tbData">
  <thead>
  <tr>
    <th>序号</th>
    <th>捐赠人</th>
    <th>受捐单位</th>
    <th>金额</th>
    <th>受捐日期</th>
    <th>操作</th>
  </tr>
  </thead>
  <tbody id="tbody">

  </tbody>
</table>


<script>

  //功能一：获取元素
  var selSearchOrg = document.getElementById("selSearchOrg");//查询用的下拉框
  var selAddOrg = document.getElementById("selAddOrg");
  var tbody = document.querySelector("tbody");
  var btnSearch = document.getElementById("btnSearch");
  var btnAdd = document.getElementById("btnAdd");
  var txtName = document.getElementById("txtName");
  var txtMoney = document.getElementById("txtMoney");
  var txtDate = document.getElementById("txtDate");

  //功能二：初始化下拉框
  var listOrgs = [
    {id: 0, name: "红十字会"},
    {id: 1, name: "传智播客"},
    {id: 2, name: "黑马程序员"},
    {id: 3, name: "前端22期"},
  ];
  //初始化查询的下拉框
  initSelect(selSearchOrg);
  //初始化增加的下拉框
  initSelect(selAddOrg);

  //初始化select框
  //参数：初始化哪个select
  function initSelect(element) {
    for(var i = 0;  i < listOrgs.length; i++) {
      //1. 动态生成option
      var option = document.createElement("option");
      //2. 设置option的内容
      option.innerText = listOrgs[i].name;
      //3. 设置option的value值
      option.value = listOrgs[i].id;
      //4. 把option添加到selSearchOrg
      element.appendChild(option);
    }
  }

  //功能三：列表显示
  var listMoney = [
    {id: 1, username: "张三", orgId: 1, money: 10000, date: '2018-02-04'},
    {id: 2, username: "李四", orgId: 2, money: 20000, date: '2018-03-02'},
    {id: 3, username: "王五", orgId: 0, money: 30000, date: '2018-04-02'},
    {id: 4, username: "王五1", orgId: 3, money: 40000, date: '2018-04-03'},
    {id: 5, username: "王五2", orgId: 1, money: 50000, date: '2018-04-04'},
    {id: 6, username: "王五3", orgId: 1, money: 60000, date: '2018-04-05'},
    {id: 7, username: "王五4", orgId: 3, money: 70000, date: '2018-04-06'},
    {id: 8, username: "王五5", orgId: 0, money: 80000, date: '2018-04-07'}
  ];
  var count = 8;
  for (var i = 0; i < listMoney.length; i++) {
    var tr = document.createElement("tr");
    tbody.appendChild(tr);
    for (var k in listMoney[i]) {
      var td = document.createElement("td");
      tr.appendChild(td);
      td.innerText = listMoney[i][k];
    }
    var td = document.createElement("td");
    tr.appendChild(td);
  }
  render(listMoney);
    //功能二：显示列表（动态创建结构）
  //遍历listMoney,动态创建tr
  render(listMoney);

  //功能三：查询功能
  btnSearch.addEventListener("click", function () {
    //先根据下拉框的值，获取到一个对应的数组
    var newArr = [];
    for(var i = 0; i < listMoney.length; i++) {
      //如果下拉框的值=-1   或者是下拉框的值=listMoney[i].orgId
      if(selSearchOrg.value == -1 || selSearchOrg.value == listMoney[i].orgId) {
        newArr.push(listMoney[i]);
      }
    }

    render(newArr);


  });



  function getOrgNameById(orgId) {
    //先根据orgId找到listOrgs这个数组中对应的那个对象，返回这个对象的name属性
    for (var i = 0; i < listOrgs.length; i++) {
      if (orgId == listOrgs[i].id) {
        return listOrgs[i].name;
      }
    }

    return "没有这个组织";
  }


  function render(datas) {
    tbody.innerHTML = "";
    for (var i = 0; i < datas.length; i++) {
      var tr = document.createElement("tr");
      tbody.appendChild(tr);
      //根据listMoney[i]动态创建td
      for (var k in datas[i]) {
        //创建td
        var td = document.createElement("td");
        //添加到tr
        tr.appendChild(td);
        //设置td的内容，判断，如果是orgId，需要额外的处理
        if (k == "orgId") {
          td.innerText = getOrgNameById( datas[i][k] );
        } else {
          td.innerText = datas[i][k];
        }

      }
      //需要额外生成一个td
      var td = document.createElement("td");
      tr.appendChild(td);
      
      //功能五：
      //1. 在td里面生成一个button
      //2. 还应该button增加click事件
      //3. 点击的时候，需要把数组中对应的那个对象删除
      //4. 重新渲染（删除当前按钮所在的tr）
      var button = document.createElement("button");
      button.innerText = "删";
      //在按钮上存储了id
      button.index = datas[i].id;
      td.appendChild(button);

      button.addEventListener("click", function () {
        var index = this.index;

        //删除listMoney中id叫做index的那个元素。
        for(var i = 0 ; i < listMoney.length; i++) {
          if(listMoney[i].id == index){
            listMoney.splice(i, 1);
            break;
          }
        }

        btnSearch.click();


      });



    }
  }


// 功能四：新增功能
  // 1.注册事件
  // 2.获取到捐赠人，手绢单位等
  // 3.把对象添加到listMoney中
  // 4.重新渲染一边
  btnAdd.addEventListener("click", function () {
    var username = txtName.value;
    var orgId = selAddOrg.value;
    var money = txtMoney.value;
    var date = txtDate.value;
    var id = ++count;

    txtName.value = "";

    //select.value = 1
    selAddOrg.value = 1;
    txtMoney.value = "";
    txtDate.value = "";

    var obj = {
      id:id,
      username:username,
      orgId:orgId,
      money:money,
      date:date
    }

    listMoney.push(obj);

    render(listMoney);
  });
  btnAdd.addEventListener("click", function () {
    var username = txtName.value;
    var orgId = selAddOrg.value;
    var money = txtMoney.value;
    var date = txtDate.value;
    var id = ++count;

    var obj = {
      id:id,
      username:username,
      orgId:orgId,
      money:money,
      date:date
    }
    listMoney.push(obj);
    render(listMoney);
  });

  // 功能五：删除功能
  

</script>

</body>
</html>
